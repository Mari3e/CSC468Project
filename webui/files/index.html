<!doctype html>
<html>
<head>
<title>Coin Balance</title>
<link rel="stylesheet" type="text/css" href="rickshaw.min.css">
<style>
#graph {
    background-color: rgb(255,255,230);
    width: 800px;
    height: 400px;
    display: grid;
    grid-template-columns: auto;
    align-items: center;
    justify-self: center;
    margin: 0 auto;
    border-radius: 25px;

}
#tweet {
    color: whitesmoke;
}
#stonks {
  opacity: 0.5;
  width: 60%;
  height: 40%;
  padding-top: 0px;
}
h1 {
    text-align: center;
    font-size: 40px;
    color: orange;
}

h2 {
    text-align: center;
    font-size: 1.5rem;
    color: whitesmoke;
}

body {
    background-image: linear-gradient(rgb(102,179,255), gray);
}
</style>
<script src="jquery-1.11.3.min.js"></script>
<script src="d3.min.js"></script>
<script src="rickshaw.min.js"></script>
<script>

String.prototype.format = function () {
    var args = arguments;
    return this.replace(/\{(\d+)\}/g, function (m, n) { return args[n]; });
};

var series = [];
var points = []
var graph = null;
// Default users
var users = ["Declan", "Meredith", "Shomari", "Greg", "Patrick"];
var currentUser = "";

// recursive log in function that allows for adding a new user if the one entered
// is not present
function logIn(){
  let user = window.prompt("Please enter your username")
  if (users.indexOf(user) > -1)
  {
    currentUser = user;
    window.alert("Logged in as " + user);
  }
  else {
    if (window.confirm("This user does not exist: Add " + user + "?"))
    {
            users.push(user);
            currentUser = user;
            window.alert("Logged in as " + user);
    }
    else {
      logIn();
    }
  }
}

function refresh () {
    $.ajax({ url: "json" }).done(function (data) {
        series.push(data);
        while (series.length < 250) {
            data = JSON.parse(JSON.stringify(data));
            data.now -= 1;
            series.unshift(data);
        }
        while (series.length > 250) {
            series.shift();
        }
        while (points.length > 0) {
            points.pop();
        }
        var speed;
        for (var i=0; i<series.length-1; i++) {
            // Compute instantaneous speed
            var s1 = series[i];
            var s2 = series[i+1];
            speed = (s2.hashes-s1.hashes)/(s2.now-s1.now);
            points.push({ x: s2.now, y: speed });
        }
        $("#speed").text("~" + speed.toFixed(1) + " hashes/second");
        var msg = ("I'm attending a @docker orchestration workshop, "
                   + "and my #DockerCoins mining rig is crunching "
                   + speed.toFixed(1) + " hashes/second! W00T!");
        $("#tweet").attr(
            "href",
            "https://twitter.com/intent/tweet?text="+encodeURIComponent(msg)
        );
        if (graph == null) {
            graph = new Rickshaw.Graph({
                renderer: "area",
                stroke: true,
                width: 800,
                height: 400,
                element: $("#graph")[0],
                preserve: true,
                series: [
                    { name: "Coins",
                      color: "steelblue",
                      data: points
                    }
                ]
            });
            graph.render();
            var yAxis = new Rickshaw.Graph.Axis.Y({
                graph: graph,
                tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
                ticksTreatment: "glow"
            });
            yAxis.render();
        } else {
            graph.update();
            $("text").css({
                "font-size": "15px",
                "font-weight": "normal",
                "opacity": 0.5,
            });
        }
    });
}

logIn();

$(function () {
    setInterval(refresh, 1000);
});
</script>
</head>
<body>

<h1>Coin Balance</h1>

<div id="graph"></div>
<div id="stonks"><img src="images/stonks.png" alt="Stonk Man"></div>
<h2>
  Current mining speed:
  <span id="speed">-</span>
  <a id="tweet" href="#">(Tweet this!)</a>
</h2>
</body>
</html>
